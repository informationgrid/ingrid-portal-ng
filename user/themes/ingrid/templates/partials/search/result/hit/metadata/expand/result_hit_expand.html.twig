{% import 'macros/hit/hit_default_macros.html.twig' as hit_macros %}

{% set search_hit_csw_enabled = theme_var('search_hit_csw_enabled') %}
{% set search_hit_csw_url = theme_var('hit_csw_url') %}
{% set map_leaflet_config = theme_var('map.leaflet') %}

{% set counter = counter %}
{% set hit = hit %}
{% set uuid = getHitUuid(hit) %}
{% set mapUrl = getHitMapUrl(hit) %}
{% set mapUrlClient = getHitMapUrlClient(hit) %}
{% set partner = getHitPartner(hit) %}
{% set downloads = getHitLinks(hit)|filterLinks("download") %}
{% set references = getHitLinks(hit)|filterLinks("reference") %}
{% set access = getHitLinks(hit)|filterLinks("access") %}
{% set others = getHitLinks(hit)|filterLinks("other") %}
{% set previews = getHitLinks(hit)|filterLinks("preview") %}
{% set licenses = getHitLicences(hit) %}
{% set bboxes = getHitBboxes(hit) %}
{% set wkt = getHitWKT(hit) %}

{% set param_hit_open = uri.query('more') %}
{% set hitsOpen = param_hit_open|split(',') %}
{% set hitOpenId = 'hit_open_' ~ counter %}
{% set isHitOpen = hitOpenId in hitsOpen %}
{% set hitMapId = 'hit_map_' ~ counter %}


{% if downloads|length > 0
    or references|length > 0
    or access|length > 0
    or others|length > 0
    or previews|length > 0
    or bboxes|length > 0
    or wkt
    or mapUrl
    or mapUrlClient
%}

    <a id="{{ hitOpenId }}" class="js-expander {% if isHitOpen %}is-hidden{% endif %}" title="Mehr Infos" href="#" {% if bboxes|length > 0 %}onclick="resizeMap({{ hitMapId }})"{% endif %}>
        <span class="icon  ic-ic-plus"></span>
        <span class="text">Mehr Infos</span>
    </a>
    <a class="js-expander-close {{ hitOpenId }} {% if not isHitOpen %}is-hidden{% endif %}" title="Weniger Infos" href="#">
        <span class="icon  ic-ic-minus"></span>
        <span class="text">Weniger Infos</span>
    </a>
    <div class="js-expander-content {{ hitOpenId }} {% if not isHitOpen %}is-hidden{% endif %}">
        <div class="row">
            <div class="xsmall-24 small-24 medium-14 large-14 xlarge-14 columns">
{# URL des Zugangs #}
                {% if access|length > 0 %}
                    <div class="sub-section">
                        {{ hit_macros.render_fact_title('URL des Zuganges', access|length) }}
                        <div class="document-list">
                            {% for link in access %}
                            <div class="list-item">
                                <div>
                                    {% if link.type %}
                                    <div class="info--right"><span>{{ link.format }}</span></div>
                                    {% endif %}
                                    <a href="{{ link.url }}" class="icon external-link" title="{{ link.title }}" target="_blank" rel="noopener noreferrer">
                                        <span class="ic-ic-external"></span>
                                        <span class="text">
                                            {{ link.title ?? link.url }}
                                        </span>
                                    </a>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
{# Verweise und Downloads #}
                {% if downloads|length > 0 or  links|length > 0 %}
                    <div class="sub-section">
                        {{ hit_macros.render_fact_title('Verweise und Downloads', downloads|length + links|length) }}
                        <div class="document-list">
{# Downloads #}
                            {% for link in downloads %}
                            <div class="list-item">
                                <div>
                                    {% if link.type %}
                                    <div class="info--right"><span>{{ link.format }}</span></div>
                                    {% endif %}
                                    <a href="{{ link.url }}" class="icon external-link" title="{{ link.title }}" target="_blank" rel="noopener noreferrer">
                                        <span class="ic-ic-download"></span>
                                        <span class="text">
                                            {{ link.title ?? link.url }}
                                        </span>
                                    </a>
                                </div>
                            </div>
                            {% endfor %}
{# Verweise #}
                            {% for link in references %}
                            <div class="list-item">
                                <div>
                                    {% if link.type %}
                                    <div class="info--right"><span>{{ link.format }}</span></div>
                                    {% endif %}
                                    <a href="{{ link.url }}" class="icon" title="{{ link.title }}">
                                        {{ hit_macros.render_metadata_icon(link.class, link.title ?? link.url, link.class_name)}}
                                    </a>
                                </div>
                            </div>
                            {% endfor %}
{# Weitere Verweise #}
                            {% for link in others %}
                            <div class="list-item">
                                <div>
                                    {% if link.type %}
                                    <div class="info--right"><span>{{ link.format }}</span></div>
                                    {% endif %}
                                    <a href="{{ link.url }}" class="icon external-link" title="{{ link.title }}" target="_blank" rel="noopener noreferrer">
                                        <span class="ic-ic-external"></span>
                                        <span class="text">
                                            {{ link.title ?? link.url }}
                                        </span>
                                    </a>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
{# Nutzungsbedingungen #}
                {% if licenses|length > 0 %}
                    {{ hit_macros.render_fact_title('Nutzungsbedingungen') }}
                    {% for license in licenses %}
                        {% if license.text %}
                            <p>{{ license.text| raw }}</p>
                        {% elseif license.url %}
                            <p>
                                <a class="icon external-link" href="{{ license.url }}" title="{{ license.title }}" target="_blank" rel="noopener noreferrer">
                                    <span class="ic-ic-external"></span>
                                    <span class="text">{{ license.title }}</span>
                                </a>
                            </p>
                        {% endif %}
                    {% endfor %}
                {% endif %}
{# XML Darstellung #}
                {% if search_hit_csw_enabled and search_hit_csw_url and uuid %}
                    <p class="teaser-links-content">
                        <a class="icon external-link" href="{{search_hit_csw ~ uuid}}" title="XML Darstellung" target="_blank" rel="noopener noreferrer">
                            <span class="ic-ic-download"></span>
                            <span class="text">XML Darstellung</span>
                        </a>
                    </p>
                {% endif %}
            </div>
{# Vorschau / Karte #}
            <div class="columns">
                {% if previews|length > 0 and bboxes|length > 0 %}
                    <div class="swiper-container_{{ hitOpenId }} swiper-container swiper-container-background">
                        <div class="swiper-wrapper">
                {% else %}
                    <div class="swiper-container-background">
                {% endif %}
{# Vorschau #}
                {% if previews|length > 0 %}
                    {% for link in previews %}
                        <div class="swiper-slide">
                            {{ hit_macros.render_fact_title('Vorschau', null, 'text-center') }}
                            <a href="{{ link.url }}" title="{{ link.title ?? 'Vorschau' }}" target="_blank" class="external-link" rel="noopener noreferrer" onerror="loadDefaultMapImage(this,'{{ partner}}')">
                                <img src="{{ link.url }}" height="100" class="preview_image" alt="{{ link.title ?? link.url }}" >
                            </a>
                        </div>
                    {% endfor %}
                    <script>
                      var swiper_{{ hitOpenId }} = new Swiper ("{{'.swiper-container_' ~ hitOpenId }}", {
                        spaceBetween: 10,
                        grabCursor: true,
                        updateOnWindowResize: true,
                        observer: true,
                        observeParents: true,
                        pagination: {
                          el: '.swiper-pagination',
                          clickable: true
                        }
                      });
                    </script>
                {% endif %}
{# Karte #}
                {% if bboxes|length > 0 %}
                    {% if previews|length > 0 and bboxes|length > 0 %}
                        <div class="swiper-slide">
                    {% endif %}
                    {{ hit_macros.render_fact_title('Raumbezug', null, 'text-center') }}
                    <div id="{{ hitMapId }}" class="map-ingrid" style="height:320px; margin-bottom: 24px;"></div>
                    <script>
                        $('#_map{{ hitOpenId }}').closest('.js-expander-content').removeClass('is-hidden');
                        var bboxes = {{ bboxes|json_encode()|raw }};
                        var wkt = {{ wkt|json_encode()|raw }};
                        var config = JSON.parse('{{ map_leaflet_config|json_encode()|raw }}');
                        var {{ hitMapId }} = addHitLeafletMap('{{ hitMapId }}', L.CRS.EPSG{{ map_leaflet_config.epsg }}, bboxes, wkt, null, false, config);
                        {% if not isHitOpen %}
                            $('#{{ hitMapId }}').closest('.js-expander-content').addClass('is-hidden');
                        {% endif %}
                    </script>
                    {% if previews|length > 0 and bboxes|length > 0 %}
                        </div>
                    {% endif %}
                {% endif %}

                {% if previews|length > 0 and bboxes|length > 0 %}
                        </div>
                        <div class="swiper-pagination"></div>
                    </div>
                {% else %}
                    </div>
                {% endif %}
{# Kartenansicht #}
                {% if mapUrlClient or mapUrl %}
                <p class="caption">
                    <a target="_blank" class="button small" href="{{ mapUrlClient ?? mapUrl }}" title="{{ "COMMON.RESULT_SHOWMAP_TOOLTIP"|t }}">
                        Kartenansicht anzeigen
                    </a>
                </p>
                {% endif %}
            </div>
        </div>
    </div>
{% endif %}